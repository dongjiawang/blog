<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<title>使用百度地图进行定位和路线规划 - 我的码</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<meta http-equiv=cache-control content="no-transform">
<meta http-equiv=cache-control content="no-siteapp">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=author content="dongjiawang"><meta name=description content="先去百度地图开发者中心申请APPkey：百度开发者中心 ，下载百度地图的SDK。 导入SDK的framework文件，BaiduMapAPI_B"><meta name=keywords content="Hugo,theme,even">
<meta name=generator content="Hugo 0.89.3 with theme even">
<link rel=canonical href=https://blog.dongjiawang.top/post/2015-11-27-baidumapsdk/>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/manifest.json>
<link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5>
<link href=/sass/main.min.cb68f97bc9cece255d217346d970e3c62623408634e500c330a62fadabbbe77c.css rel=stylesheet>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous>
<meta property="og:title" content="使用百度地图进行定位和路线规划">
<meta property="og:description" content="先去百度地图开发者中心申请APPkey：百度开发者中心 ，下载百度地图的SDK。 导入SDK的framework文件，BaiduMapAPI_B">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.dongjiawang.top/post/2015-11-27-baidumapsdk/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2015-11-27T16:19:00+00:00">
<meta property="article:modified_time" content="2015-11-27T16:19:00+00:00">
<meta itemprop=name content="使用百度地图进行定位和路线规划">
<meta itemprop=description content="先去百度地图开发者中心申请APPkey：百度开发者中心 ，下载百度地图的SDK。 导入SDK的framework文件，BaiduMapAPI_B"><meta itemprop=datePublished content="2015-11-27T16:19:00+00:00">
<meta itemprop=dateModified content="2015-11-27T16:19:00+00:00">
<meta itemprop=wordCount content="4742">
<meta itemprop=keywords content="iOS,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="使用百度地图进行定位和路线规划">
<meta name=twitter:description content="先去百度地图开发者中心申请APPkey：百度开发者中心 ，下载百度地图的SDK。 导入SDK的framework文件，BaiduMapAPI_B"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>我的码</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<a href=/>
<li class=mobile-menu-item>首页</li>
</a><a href=/post/>
<li class=mobile-menu-item>归档</li>
</a><a href=/tags/>
<li class=mobile-menu-item>标签</li>
</a><a href=/categories/>
<li class=mobile-menu-item>分类</li>
</a><a href=/about/>
<li class=mobile-menu-item>关于</li>
</a>
</ul>
</nav>
<div class=container id=mobile-panel>
<header id=header class=header>
<div class=logo-wrapper>
<a href=/ class=logo>我的码</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=/>首页</a>
</li><li class=menu-item>
<a class=menu-item-link href=/post/>归档</a>
</li><li class=menu-item>
<a class=menu-item-link href=/tags/>标签</a>
</li><li class=menu-item>
<a class=menu-item-link href=/categories/>分类</a>
</li><li class=menu-item>
<a class=menu-item-link href=/about/>关于</a>
</li>
</ul>
</nav>
</header>
<main id=main class=main>
<div class=content-wrapper>
<div id=content class=content>
<article class=post>
<header class=post-header>
<h1 class=post-title>使用百度地图进行定位和路线规划</h1>
<div class=post-meta>
<span class=post-time> 2015-11-27 </span>
<div class=post-category>
<a href=/categories/libsdk/> libSDK </a>
</div>
<span class=more-meta> 约 4742 字 </span>
<span class=more-meta> 预计阅读 10 分钟 </span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>文章目录</h2>
<div class=post-toc-content>
<nav id=TableOfContents></nav>
</div>
</div>
<div class=post-content>
<p>先去百度地图开发者中心申请APPkey：<a href="http://developer.baidu.com/map/index.php?title=iossdk">百度开发者中心</a> ，下载百度地图的SDK。</p>
<p>导入SDK的framework文件，<code>BaiduMapAPI_Base.framework</code> 是基础包，是必须要导入的，根据自己的需求导入需要的百度SDK的framework，新版的SDK已经可以选择下载哪些framework，减小了包的大小。</p>
<p>引入所需的系统库，在Xcode工程中引入</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=n>CoreLocation</span><span class=p>.</span><span class=n>framework</span>

<span class=n>QuartzCore</span><span class=p>.</span><span class=n>framework</span>

<span class=n>OpenGLES</span><span class=p>.</span><span class=n>framework</span>

<span class=n>SystemConfiguration</span><span class=p>.</span><span class=n>framework</span>

<span class=n>CoreGraphics</span><span class=p>.</span><span class=n>framework</span>

<span class=n>Security</span><span class=p>.</span><span class=n>framework</span>

<span class=n>libsqlite3</span><span class=mf>.0</span><span class=p>.</span><span class=n>tbd</span><span class=err>（</span><span class=n>xcode7以前为</span> <span class=n>libsqlite3</span><span class=mf>.0</span><span class=p>.</span><span class=n>dylib</span><span class=err>）</span>

<span class=n>CoreTelephony</span><span class=p>.</span><span class=n>framework</span>

<span class=n>libstdc</span><span class=o>++</span><span class=mf>.6.0.9</span><span class=p>.</span><span class=n>tbd</span><span class=err>（</span><span class=n>xcode7以前为libstdc</span><span class=o>++</span><span class=mf>.6.0.9</span><span class=p>.</span><span class=n>dylib</span><span class=err>）</span>
</code></pre></td></tr></table>
</div>
</div><p>根据需求引入头文件，我们只要定位，搜索和路线绘制，所以不必要全部引入。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=cp>#import &lt;BaiduMapAPI_Base/BMKBaseComponent.h&gt;</span><span class=c1>//引入base相关所有的头文件
</span><span class=c1></span> 
<span class=cp>#import &lt;BaiduMapAPI_Map/BMKMapComponent.h&gt;</span><span class=c1>//引入地图功能所有的头文件
</span><span class=c1></span> 
<span class=cp>#import &lt;BaiduMapAPI_Search/BMKSearchComponent.h&gt;</span><span class=c1>//引入检索功能所有的头文件
</span><span class=c1></span> 
<span class=cp>#import &lt;BaiduMapAPI_Cloud/BMKCloudSearchComponent.h&gt;</span><span class=c1>//引入云检索功能所有的头文件
</span><span class=c1></span> 
<span class=cp>#import &lt;BaiduMapAPI_Location/BMKLocationComponent.h&gt;</span><span class=c1>//引入定位功能所有的头文件
</span><span class=c1></span> 
<span class=cp>#import &lt;BaiduMapAPI_Utils/BMKUtilsComponent.h&gt;</span><span class=c1>//引入计算工具所有的头文件
</span><span class=c1></span> 
<span class=cp>#import &lt;BaiduMapAPI_Radar/BMKRadarComponent.h&gt;</span><span class=c1>//引入周边雷达功能所有的头文件
</span><span class=c1></span> 
<span class=cp>#import &lt; BaiduMapAPI_Map/BMKMapView.h&gt;</span><span class=c1>//只引入所需的单个头文件
</span></code></pre></td></tr></table>
</div>
</div><p><strong>下面开始进行代码的实践：</strong></p>
<p>首先引用代理方法：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=n>BMKMapViewDelegate</span><span class=c1>//基础代理
</span><span class=c1></span><span class=n>BMKRouteSearchDelegate</span><span class=c1>//搜索代理
</span><span class=c1></span><span class=n>BMKLocationServiceDelegate</span><span class=c1>//定位代理
</span><span class=c1></span><span class=n>BMKGeoCodeSearchDelegate</span><span class=c1>//地理反编码代理
</span></code></pre></td></tr></table>
</div>
</div><p>定义声明文件：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=k>@interface</span> <span class=nc>RouteSearchDemoViewController</span> : <span class=nc>BaseViewCtrl</span><span class=o>&lt;</span><span class=n>BMKMapViewDelegate</span><span class=p>,</span> <span class=n>BMKRouteSearchDelegate</span><span class=p>,</span><span class=n>BMKLocationServiceDelegate</span><span class=p>,</span><span class=n>BMKGeoCodeSearchDelegate</span><span class=o>&gt;</span> <span class=p>{</span>
    <span class=kt>IBOutlet</span> <span class=n>BMKMapView</span><span class=o>*</span> <span class=n>_mapView</span><span class=p>;</span><span class=c1>//地图view
</span><span class=c1></span>    <span class=kt>IBOutlet</span> <span class=n>UITextField</span><span class=o>*</span> <span class=n>_startCityText</span><span class=p>;</span><span class=c1>//开始的城市
</span><span class=c1></span>    <span class=kt>IBOutlet</span> <span class=n>UITextField</span><span class=o>*</span> <span class=n>_startAddrText</span><span class=p>;</span><span class=c1>//开始的位置
</span><span class=c1></span>    <span class=kt>IBOutlet</span> <span class=n>UITextField</span><span class=o>*</span> <span class=n>_endCityText</span><span class=p>;</span><span class=c1>//终点城市
</span><span class=c1></span>    <span class=kt>IBOutlet</span> <span class=n>UITextField</span><span class=o>*</span> <span class=n>_endAddrText</span><span class=p>;</span><span class=c1>//终点位置
</span><span class=c1></span>    <span class=n>BMKRouteSearch</span><span class=o>*</span> <span class=n>_routesearch</span><span class=p>;</span><span class=c1>//搜索
</span><span class=c1></span>    <span class=n>BMKLocationService</span> <span class=o>*</span><span class=n>locService</span><span class=p>;</span><span class=c1>//定位
</span><span class=c1></span><span class=p>}</span>

<span class=o>-</span><span class=p>(</span><span class=kt>IBAction</span><span class=p>)</span><span class=n>onClickBusSearch</span><span class=p>;</span><span class=c1>//公交路线
</span><span class=c1></span><span class=p>-(</span><span class=kt>IBAction</span><span class=p>)</span><span class=nf>onClickDriveSearch</span><span class=p>;</span><span class=c1>//开车路线
</span><span class=c1></span><span class=p>-(</span><span class=kt>IBAction</span><span class=p>)</span><span class=nf>onClickWalkSearch</span><span class=p>;</span><span class=c1>//不行路线
</span><span class=c1></span><span class=p>-</span> <span class=p>(</span><span class=kt>IBAction</span><span class=p>)</span><span class=nf>textFiledReturnEditing:</span><span class=p>(</span><span class=kt>id</span><span class=p>)</span><span class=nv>sender</span><span class=p>;</span>

<span class=k>@property</span><span class=p>(</span><span class=k>nonatomic</span><span class=p>,</span><span class=k>retain</span><span class=p>)</span><span class=n>MapAlertView</span> <span class=o>*</span><span class=n>mapview</span><span class=p>;</span><span class=c1>//一个遮盖view
</span><span class=c1></span><span class=k>@end</span>
</code></pre></td></tr></table>
</div>
</div><p>使用的是类中使用了XIB文件，所以根据自己的需要进行控件的拖放、位置及大小设置。</p>
<p>在实现文件中添加一个图片出的函数，有些路线的绘制和图标的变化需要用到（百度的Demo中就有这个函数）</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=k>@implementation</span> <span class=nc>UIImage</span><span class=nl>(InternalMethod)</span>

<span class=p>-</span> <span class=p>(</span><span class=n>UIImage</span><span class=o>*</span><span class=p>)</span><span class=nf>imageRotatedByDegrees:</span><span class=p>(</span><span class=n>CGFloat</span><span class=p>)</span><span class=nv>degrees</span> <span class=p>{</span>
    
    <span class=n>CGFloat</span> <span class=n>width</span> <span class=o>=</span> <span class=n>CGImageGetWidth</span><span class=p>(</span><span class=nb>self</span><span class=p>.</span><span class=n>CGImage</span><span class=p>);</span>
    <span class=n>CGFloat</span> <span class=n>height</span> <span class=o>=</span> <span class=n>CGImageGetHeight</span><span class=p>(</span><span class=nb>self</span><span class=p>.</span><span class=n>CGImage</span><span class=p>);</span>
    
    <span class=n>CGSize</span> <span class=n>rotatedSize</span><span class=p>;</span>
    
    <span class=n>rotatedSize</span><span class=p>.</span><span class=n>width</span> <span class=o>=</span> <span class=n>width</span><span class=p>;</span>
    <span class=n>rotatedSize</span><span class=p>.</span><span class=n>height</span> <span class=o>=</span> <span class=n>height</span><span class=p>;</span>
    
    <span class=n>UIGraphicsBeginImageContext</span><span class=p>(</span><span class=n>rotatedSize</span><span class=p>);</span>
    <span class=n>CGContextRef</span> <span class=n>bitmap</span> <span class=o>=</span> <span class=n>UIGraphicsGetCurrentContext</span><span class=p>();</span>
    <span class=n>CGContextTranslateCTM</span><span class=p>(</span><span class=n>bitmap</span><span class=p>,</span> <span class=n>rotatedSize</span><span class=p>.</span><span class=n>width</span><span class=o>/</span><span class=mi>2</span><span class=p>,</span> <span class=n>rotatedSize</span><span class=p>.</span><span class=n>height</span><span class=o>/</span><span class=mi>2</span><span class=p>);</span>
    <span class=n>CGContextRotateCTM</span><span class=p>(</span><span class=n>bitmap</span><span class=p>,</span> <span class=n>degrees</span> <span class=o>*</span> <span class=n>M_PI</span> <span class=o>/</span> <span class=mi>180</span><span class=p>);</span>
    <span class=n>CGContextRotateCTM</span><span class=p>(</span><span class=n>bitmap</span><span class=p>,</span> <span class=n>M_PI</span><span class=p>);</span>
    <span class=n>CGContextScaleCTM</span><span class=p>(</span><span class=n>bitmap</span><span class=p>,</span> <span class=o>-</span><span class=mf>1.0</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>);</span>
    <span class=n>CGContextDrawImage</span><span class=p>(</span><span class=n>bitmap</span><span class=p>,</span> <span class=n>CGRectMake</span><span class=p>(</span><span class=o>-</span><span class=n>rotatedSize</span><span class=p>.</span><span class=n>width</span><span class=o>/</span><span class=mi>2</span><span class=p>,</span> <span class=o>-</span><span class=n>rotatedSize</span><span class=p>.</span><span class=n>height</span><span class=o>/</span><span class=mi>2</span><span class=p>,</span> <span class=n>rotatedSize</span><span class=p>.</span><span class=n>width</span><span class=p>,</span> <span class=n>rotatedSize</span><span class=p>.</span><span class=n>height</span><span class=p>),</span> <span class=nb>self</span><span class=p>.</span><span class=n>CGImage</span><span class=p>);</span>
    <span class=n>UIImage</span><span class=o>*</span> <span class=n>newImage</span> <span class=o>=</span> <span class=n>UIGraphicsGetImageFromCurrentImageContext</span><span class=p>();</span>
    <span class=n>UIGraphicsEndImageContext</span><span class=p>();</span>
    <span class=k>return</span> <span class=n>newImage</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>@end</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>下面就到了地图的真正实施阶段：</strong></p>
<p>封装一个获取资源文件的函数，从百度的bundle中获取图片等等：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>viewDidLoad</span> <span class=p>{</span>
    <span class=p>[</span><span class=nb>super</span> <span class=n>viewDidLoad</span><span class=p>];</span>
    <span class=c1>//适配ios7
</span><span class=c1></span>    <span class=k>if</span><span class=p>(</span> <span class=p>([[[</span><span class=n>UIDevice</span> <span class=n>currentDevice</span><span class=p>]</span> <span class=n>systemVersion</span><span class=p>]</span> <span class=n>doubleValue</span><span class=p>]</span><span class=o>&gt;=</span><span class=mf>7.0</span><span class=p>))</span>
    <span class=p>{</span>
        <span class=nb>self</span><span class=p>.</span><span class=n>navigationController</span><span class=p>.</span><span class=n>navigationBar</span><span class=p>.</span><span class=n>translucent</span> <span class=o>=</span> <span class=nb>NO</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>_routesearch</span> <span class=o>=</span> <span class=p>[[</span><span class=n>BMKRouteSearch</span> <span class=n>alloc</span><span class=p>]</span> <span class=n>init</span><span class=p>];</span>
     <span class=n>_routesearch</span><span class=p>.</span><span class=n>delegate</span> <span class=o>=</span> <span class=nb>self</span><span class=p>;</span>
    <span class=p>[</span><span class=n>_mapView</span> <span class=nl>setZoomEnabled</span><span class=p>:</span><span class=nb>YES</span><span class=p>];</span>
    <span class=p>[</span><span class=n>_mapView</span> <span class=nl>setZoomLevel</span><span class=p>:</span><span class=mi>13</span><span class=p>];</span><span class=c1>//级别，3-19
</span><span class=c1></span>    <span class=n>_mapView</span><span class=p>.</span><span class=n>showMapScaleBar</span> <span class=o>=</span> <span class=nb>YES</span><span class=p>;</span><span class=c1>//比例尺
</span><span class=c1></span>    <span class=n>_mapView</span><span class=p>.</span><span class=n>mapScaleBarPosition</span> <span class=o>=</span> <span class=n>CGPointMake</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span><span class=n>_mapView</span><span class=p>.</span><span class=n>frame</span><span class=p>.</span><span class=n>size</span><span class=p>.</span><span class=n>height</span><span class=o>-</span><span class=mi>45</span><span class=p>);</span><span class=c1>//比例尺的位置
</span><span class=c1></span>    <span class=n>_mapView</span><span class=p>.</span><span class=n>showsUserLocation</span><span class=o>=</span><span class=nb>YES</span><span class=p>;</span><span class=c1>//显示当前设备的位置
</span><span class=c1></span>    <span class=n>_mapView</span><span class=p>.</span><span class=n>userTrackingMode</span> <span class=o>=</span> <span class=n>BMKUserTrackingModeFollow</span><span class=p>;</span><span class=c1>//定位跟随模式
</span><span class=c1></span>    <span class=n>_mapView</span><span class=p>.</span><span class=n>delegate</span> <span class=o>=</span> <span class=nb>self</span><span class=p>;</span>
    <span class=p>[</span><span class=n>_mapView</span> <span class=nl>setMapType</span><span class=p>:</span><span class=n>BMKMapTypeStandard</span><span class=p>];</span><span class=c1>//地图的样式(标准地图)
</span><span class=c1></span>    
    <span class=c1>//定位
</span><span class=c1></span>    <span class=n>locService</span> <span class=o>=</span> <span class=p>[[</span><span class=n>BMKLocationService</span> <span class=n>alloc</span><span class=p>]</span> <span class=n>init</span><span class=p>];</span>
    <span class=n>locService</span><span class=p>.</span><span class=n>delegate</span> <span class=o>=</span> <span class=nb>self</span><span class=p>;</span>
    <span class=c1>//启动LocationService
</span><span class=c1></span>    <span class=p>[</span><span class=n>locService</span> <span class=n>startUserLocationService</span><span class=p>];</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>开始定位，并且地理反编码，获取到位置信息：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=cm>/**
</span><span class=cm> *  更新定位信息
</span><span class=cm> *
</span><span class=cm> *  @param userLocation 获取到的位置数据
</span><span class=cm> */</span>
<span class=p>-(</span><span class=kt>void</span><span class=p>)</span><span class=nf>didUpdateBMKUserLocation:</span><span class=p>(</span><span class=n>BMKUserLocation</span> <span class=o>*</span><span class=p>)</span><span class=nv>userLocation</span> <span class=p>{</span>
    
    <span class=n>CLLocationCoordinate2D</span> <span class=n>coordinate</span> <span class=o>=</span> <span class=n>userLocation</span><span class=p>.</span><span class=n>location</span><span class=p>.</span><span class=n>coordinate</span><span class=p>;</span>
    <span class=c1>// 缩放
</span><span class=c1></span>    <span class=n>BMKCoordinateSpan</span> <span class=n>span</span> <span class=o>=</span> <span class=n>BMKCoordinateSpanMake</span><span class=p>(</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>);</span>
    <span class=n>BMKCoordinateRegion</span> <span class=n>region</span> <span class=o>=</span> <span class=n>BMKCoordinateRegionMake</span><span class=p>(</span><span class=n>coordinate</span><span class=p>,</span> <span class=n>span</span><span class=p>);</span>
    <span class=p>[</span><span class=n>_mapView</span> <span class=nl>setRegion</span><span class=p>:</span><span class=n>region</span><span class=p>];</span>
    
    <span class=n>BMKReverseGeoCodeOption</span> <span class=o>*</span><span class=n>option</span> <span class=o>=</span> <span class=p>[[</span><span class=n>BMKReverseGeoCodeOption</span> <span class=n>alloc</span><span class=p>]</span> <span class=n>init</span><span class=p>];</span>
    <span class=n>option</span><span class=p>.</span><span class=n>reverseGeoPoint</span> <span class=o>=</span> <span class=n>CLLocationCoordinate2DMake</span><span class=p>(</span><span class=n>userLocation</span><span class=p>.</span><span class=n>location</span><span class=p>.</span><span class=n>coordinate</span><span class=p>.</span><span class=n>latitude</span><span class=p>,</span> <span class=n>userLocation</span><span class=p>.</span><span class=n>location</span><span class=p>.</span><span class=n>coordinate</span><span class=p>.</span><span class=n>longitude</span><span class=p>);</span>
    <span class=n>BMKGeoCodeSearch</span> <span class=o>*</span><span class=n>geoCode</span> <span class=o>=</span> <span class=p>[[</span><span class=n>BMKGeoCodeSearch</span> <span class=n>alloc</span><span class=p>]</span> <span class=n>init</span><span class=p>];</span>
    <span class=n>geoCode</span><span class=p>.</span><span class=n>delegate</span> <span class=o>=</span> <span class=nb>self</span><span class=p>;</span>
    <span class=p>[</span><span class=n>geoCode</span> <span class=nl>reverseGeoCode</span><span class=p>:</span><span class=n>option</span><span class=p>];</span>
    <span class=p>[</span><span class=n>option</span> <span class=k>release</span><span class=p>];</span>
    <span class=p>[</span><span class=n>geoCode</span> <span class=k>release</span><span class=p>];</span>
<span class=p>}</span>
<span class=cm>/**
</span><span class=cm> *  反编码地理位置返回代理
</span><span class=cm> *
</span><span class=cm> *  @param result   返回结果
</span><span class=cm> */</span>
<span class=p>-(</span><span class=kt>void</span><span class=p>)</span><span class=nf>onGetReverseGeoCodeResult:</span><span class=p>(</span><span class=n>BMKGeoCodeSearch</span> <span class=o>*</span><span class=p>)</span><span class=nv>searcher</span> <span class=nf>result:</span><span class=p>(</span><span class=n>BMKReverseGeoCodeResult</span> <span class=o>*</span><span class=p>)</span><span class=nv>result</span> <span class=nf>errorCode:</span><span class=p>(</span><span class=n>BMKSearchErrorCode</span><span class=p>)</span><span class=nv>error</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>result</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>_startCityText</span><span class=p>.</span><span class=n>text</span> <span class=o>=</span> <span class=n>result</span><span class=p>.</span><span class=n>addressDetail</span><span class=p>.</span><span class=n>city</span><span class=p>;;</span>
        <span class=n>_startAddrText</span><span class=p>.</span><span class=n>text</span> <span class=o>=</span> <span class=n>result</span><span class=p>.</span><span class=n>addressDetail</span><span class=p>.</span><span class=n>streetName</span><span class=p>;</span>
        <span class=c1>//已经获取到经纬度，可以停止定位服务
</span><span class=c1></span>        <span class=p>[</span><span class=n>locService</span> <span class=n>stopUserLocationService</span><span class=p>];</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>经过上面的两个函数，已经可以获取到所在的城市跟位置地址，具体更加详细的信息，可以在addressDetail中看到，一般就是所在的区，街道，街道号码等。</p>
<p>在view上自己添加一个按钮，当点击的时候弹出一个自定义alertview，上面有三个按钮，分别是公交，行车，步行，并且添加一个手势，点击按钮之外的地方，remove或者隐藏alertview。</p>
<p>点击需要进行的导航线路绘制，有对应的搜索类：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=p>-(</span><span class=kt>IBAction</span><span class=p>)</span><span class=nf>onClickBusSearch</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>([</span><span class=n>_startCityText</span><span class=p>.</span><span class=n>text</span> <span class=nl>isEqualToString</span><span class=p>:</span><span class=s>@&#34;&#34;</span><span class=p>])</span> <span class=p>{</span>
         <span class=p>[</span><span class=nb>self</span> <span class=nl>AddStatusLabelWithText</span><span class=p>:</span><span class=s>@&#34;正在获取位置&#34;</span><span class=p>];</span>
        <span class=k>return</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=p>[</span><span class=nb>self</span><span class=p>.</span><span class=n>mapview</span> <span class=n>removeFromSuperview</span><span class=p>];</span>
    <span class=n>BMKPlanNode</span><span class=o>*</span> <span class=n>start</span> <span class=o>=</span> <span class=p>[[[</span><span class=n>BMKPlanNode</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>]</span> <span class=n>autorelease</span><span class=p>];</span>
    <span class=n>start</span><span class=p>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>_startAddrText</span><span class=p>.</span><span class=n>text</span><span class=p>;</span>
    <span class=n>BMKPlanNode</span><span class=o>*</span> <span class=n>end</span> <span class=o>=</span> <span class=p>[[[</span><span class=n>BMKPlanNode</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>]</span> <span class=n>autorelease</span><span class=p>];</span>
    <span class=n>end</span><span class=p>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>_endAddrText</span><span class=p>.</span><span class=n>text</span><span class=p>;</span>
    
    <span class=c1>//公交
</span><span class=c1></span>    <span class=n>BMKTransitRoutePlanOption</span> <span class=o>*</span><span class=n>transitRouteSearchOption</span> <span class=o>=</span> <span class=p>[[</span><span class=n>BMKTransitRoutePlanOption</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>];</span>
    <span class=n>transitRouteSearchOption</span><span class=p>.</span><span class=n>city</span> <span class=o>=</span> <span class=n>_startCityText</span><span class=p>.</span><span class=n>text</span><span class=p>;</span>
    <span class=n>transitRouteSearchOption</span><span class=p>.</span><span class=n>from</span> <span class=o>=</span> <span class=n>start</span><span class=p>;</span>
    <span class=n>transitRouteSearchOption</span><span class=p>.</span><span class=n>to</span> <span class=o>=</span> <span class=n>end</span><span class=p>;</span>
    <span class=kt>BOOL</span> <span class=n>flag</span> <span class=o>=</span> <span class=p>[</span><span class=n>_routesearch</span> <span class=nl>transitSearch</span><span class=p>:</span><span class=n>transitRouteSearchOption</span><span class=p>];</span>
    
    <span class=p>[</span><span class=n>transitRouteSearchOption</span> <span class=k>release</span><span class=p>];</span>
    <span class=k>if</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;bus检索发送成功&#34;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>else</span>
    <span class=p>{</span>
        <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;bus检索发送失败&#34;</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=p>-(</span><span class=kt>IBAction</span><span class=p>)</span><span class=nf>onClickDriveSearch</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>([</span><span class=n>_startCityText</span><span class=p>.</span><span class=n>text</span> <span class=nl>isEqualToString</span><span class=p>:</span><span class=s>@&#34;&#34;</span><span class=p>])</span> <span class=p>{</span>
        <span class=p>[</span><span class=nb>self</span> <span class=nl>AddStatusLabelWithText</span><span class=p>:</span><span class=s>@&#34;正在获取位置&#34;</span><span class=p>];</span>
        <span class=k>return</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=p>[</span><span class=nb>self</span><span class=p>.</span><span class=n>mapview</span> <span class=n>removeFromSuperview</span><span class=p>];</span>
    <span class=n>BMKPlanNode</span><span class=o>*</span> <span class=n>start</span> <span class=o>=</span> <span class=p>[[[</span><span class=n>BMKPlanNode</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>]</span> <span class=n>autorelease</span><span class=p>];</span>
    <span class=n>start</span><span class=p>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>_startAddrText</span><span class=p>.</span><span class=n>text</span><span class=p>;</span>
    <span class=n>BMKPlanNode</span><span class=o>*</span> <span class=n>end</span> <span class=o>=</span> <span class=p>[[[</span><span class=n>BMKPlanNode</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>]</span> <span class=n>autorelease</span><span class=p>];</span>
    <span class=n>end</span><span class=p>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>_endAddrText</span><span class=p>.</span><span class=n>text</span><span class=p>;</span>
    
    <span class=c1>/// 驾车查询基础信息类
</span><span class=c1></span>    <span class=n>BMKDrivingRoutePlanOption</span> <span class=o>*</span><span class=n>drivingRouteSearchOption</span> <span class=o>=</span> <span class=p>[[</span><span class=n>BMKDrivingRoutePlanOption</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>];</span>
    <span class=n>drivingRouteSearchOption</span><span class=p>.</span><span class=n>from</span> <span class=o>=</span> <span class=n>start</span><span class=p>;</span>
    <span class=n>drivingRouteSearchOption</span><span class=p>.</span><span class=n>to</span> <span class=o>=</span> <span class=n>end</span><span class=p>;</span>
    <span class=kt>BOOL</span> <span class=n>flag</span> <span class=o>=</span> <span class=p>[</span><span class=n>_routesearch</span> <span class=nl>drivingSearch</span><span class=p>:</span><span class=n>drivingRouteSearchOption</span><span class=p>];</span>
    <span class=p>[</span><span class=n>drivingRouteSearchOption</span> <span class=k>release</span><span class=p>];</span>
    <span class=k>if</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;car检索发送成功&#34;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>else</span>
    <span class=p>{</span>
        <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;car检索发送失败&#34;</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=p>-(</span><span class=kt>IBAction</span><span class=p>)</span><span class=nf>onClickWalkSearch</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>([</span><span class=n>_startCityText</span><span class=p>.</span><span class=n>text</span> <span class=nl>isEqualToString</span><span class=p>:</span><span class=s>@&#34;&#34;</span><span class=p>])</span> <span class=p>{</span>
    <span class=p>[</span><span class=nb>self</span> <span class=nl>AddStatusLabelWithText</span><span class=p>:</span><span class=s>@&#34;正在获取位置&#34;</span><span class=p>];</span>
    <span class=k>return</span><span class=p>;</span>
<span class=p>}</span>
    <span class=p>[</span><span class=nb>self</span><span class=p>.</span><span class=n>mapview</span> <span class=n>removeFromSuperview</span><span class=p>];</span>
    <span class=n>BMKPlanNode</span><span class=o>*</span> <span class=n>start</span> <span class=o>=</span> <span class=p>[[[</span><span class=n>BMKPlanNode</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>]</span> <span class=n>autorelease</span><span class=p>];</span>
    <span class=n>start</span><span class=p>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>_startAddrText</span><span class=p>.</span><span class=n>text</span><span class=p>;</span>
    <span class=n>BMKPlanNode</span><span class=o>*</span> <span class=n>end</span> <span class=o>=</span> <span class=p>[[[</span><span class=n>BMKPlanNode</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>]</span> <span class=n>autorelease</span><span class=p>];</span>
    <span class=n>end</span><span class=p>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>_endAddrText</span><span class=p>.</span><span class=n>text</span><span class=p>;</span>

    <span class=c1>/// 步行查询基础信息类
</span><span class=c1></span>    <span class=n>BMKWalkingRoutePlanOption</span> <span class=o>*</span><span class=n>walkingRouteSearchOption</span> <span class=o>=</span> <span class=p>[[</span><span class=n>BMKWalkingRoutePlanOption</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>];</span>
    <span class=n>walkingRouteSearchOption</span><span class=p>.</span><span class=n>from</span> <span class=o>=</span> <span class=n>start</span><span class=p>;</span>
    <span class=n>walkingRouteSearchOption</span><span class=p>.</span><span class=n>to</span> <span class=o>=</span> <span class=n>end</span><span class=p>;</span>
    <span class=kt>BOOL</span> <span class=n>flag</span> <span class=o>=</span> <span class=p>[</span><span class=n>_routesearch</span> <span class=nl>walkingSearch</span><span class=p>:</span><span class=n>walkingRouteSearchOption</span><span class=p>];</span>
    <span class=p>[</span><span class=n>walkingRouteSearchOption</span> <span class=k>release</span><span class=p>];</span>
    <span class=k>if</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;walk检索发送成功&#34;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>else</span>
    <span class=p>{</span>
        <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;walk检索发送失败&#34;</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>每个start的城市和地址都可以设置，其中公交线路的start城市和transitRouteSearchOption的城市是必须要有的，否则会检索失败或者检索不到线路；</p>
<p>发送检索成功后会回调对应的绘制线路代理方法：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>onGetTransitRouteResult:</span><span class=p>(</span><span class=n>BMKRouteSearch</span><span class=o>*</span><span class=p>)</span><span class=nv>searcher</span> <span class=nf>result:</span><span class=p>(</span><span class=n>BMKTransitRouteResult</span><span class=o>*</span><span class=p>)</span><span class=nv>result</span> <span class=nf>errorCode:</span><span class=p>(</span><span class=n>BMKSearchErrorCode</span><span class=p>)</span><span class=nv>error</span> <span class=p>{</span>

    <span class=n>MapExplainViewController</span> <span class=o>*</span><span class=n>exp</span><span class=o>=</span><span class=p>[[[</span><span class=n>MapExplainViewController</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>]</span><span class=n>autorelease</span><span class=p>];</span>
    <span class=n>exp</span><span class=p>.</span><span class=n>array</span><span class=o>=</span><span class=n>result</span><span class=p>.</span><span class=n>routes</span><span class=p>;</span>
    <span class=p>[</span><span class=nb>self</span><span class=p>.</span><span class=n>navigationController</span> <span class=nl>pushViewController</span><span class=p>:</span><span class=n>exp</span> <span class=nl>animated</span><span class=p>:</span><span class=nb>YES</span><span class=p>];</span>
    <span class=n>NSArray</span><span class=o>*</span> <span class=n>array</span> <span class=o>=</span> <span class=p>[</span><span class=n>NSArray</span> <span class=nl>arrayWithArray</span><span class=p>:</span><span class=n>_mapView</span><span class=p>.</span><span class=n>annotations</span><span class=p>];</span>
    <span class=p>[</span><span class=n>_mapView</span> <span class=nl>removeAnnotations</span><span class=p>:</span><span class=n>array</span><span class=p>];</span>
    <span class=n>array</span> <span class=o>=</span> <span class=p>[</span><span class=n>NSArray</span> <span class=nl>arrayWithArray</span><span class=p>:</span><span class=n>_mapView</span><span class=p>.</span><span class=n>overlays</span><span class=p>];</span>
    <span class=p>[</span><span class=n>_mapView</span> <span class=nl>removeOverlays</span><span class=p>:</span><span class=n>array</span><span class=p>];</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>error</span> <span class=o>==</span> <span class=n>BMK_SEARCH_NO_ERROR</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>BMKTransitRouteLine</span><span class=o>*</span> <span class=n>plan</span> <span class=o>=</span> <span class=p>(</span><span class=n>BMKTransitRouteLine</span><span class=o>*</span><span class=p>)[</span><span class=n>result</span><span class=p>.</span><span class=n>routes</span> <span class=nl>objectAtIndex</span><span class=p>:</span><span class=mi>0</span><span class=p>];</span>
        <span class=c1>// 计算路线方案中的路段数目
</span><span class=c1></span>        <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=p>[</span><span class=n>plan</span><span class=p>.</span><span class=n>steps</span> <span class=n>count</span><span class=p>];</span>
        <span class=kt>int</span> <span class=n>planPointCounts</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>BMKTransitStep</span><span class=o>*</span> <span class=n>transitStep</span> <span class=o>=</span> <span class=p>[</span><span class=n>plan</span><span class=p>.</span><span class=n>steps</span> <span class=nl>objectAtIndex</span><span class=p>:</span><span class=n>i</span><span class=p>];</span>
            <span class=k>if</span><span class=p>(</span><span class=n>i</span><span class=o>==</span><span class=mi>0</span><span class=p>){</span>
                <span class=n>RouteAnnotation</span><span class=o>*</span> <span class=n>item</span> <span class=o>=</span> <span class=p>[[</span><span class=n>RouteAnnotation</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>];</span>
                <span class=n>item</span><span class=p>.</span><span class=n>coordinate</span> <span class=o>=</span> <span class=n>plan</span><span class=p>.</span><span class=n>starting</span><span class=p>.</span><span class=n>location</span><span class=p>;</span>
                <span class=n>item</span><span class=p>.</span><span class=n>title</span> <span class=o>=</span> <span class=s>@&#34;起点&#34;</span><span class=p>;</span>
                <span class=n>item</span><span class=p>.</span><span class=n>type</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
                <span class=p>[</span><span class=n>_mapView</span> <span class=nl>addAnnotation</span><span class=p>:</span><span class=n>item</span><span class=p>];</span> <span class=c1>// 添加起点标注
</span><span class=c1></span>                <span class=p>[</span><span class=n>item</span> <span class=k>release</span><span class=p>];</span>                
            <span class=p>}</span>
            <span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=n>i</span><span class=o>==</span><span class=n>size</span><span class=o>-</span><span class=mi>1</span><span class=p>){</span>
                <span class=n>RouteAnnotation</span><span class=o>*</span> <span class=n>item</span> <span class=o>=</span> <span class=p>[[</span><span class=n>RouteAnnotation</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>];</span>
                <span class=n>item</span><span class=p>.</span><span class=n>coordinate</span> <span class=o>=</span> <span class=n>plan</span><span class=p>.</span><span class=n>terminal</span><span class=p>.</span><span class=n>location</span><span class=p>;</span>
                <span class=n>item</span><span class=p>.</span><span class=n>title</span> <span class=o>=</span> <span class=s>@&#34;终点&#34;</span><span class=p>;</span>
                <span class=n>item</span><span class=p>.</span><span class=n>type</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
                <span class=p>[</span><span class=n>_mapView</span> <span class=nl>addAnnotation</span><span class=p>:</span><span class=n>item</span><span class=p>];</span> <span class=c1>// 添加起点标注
</span><span class=c1></span>                <span class=p>[</span><span class=n>item</span> <span class=k>release</span><span class=p>];</span>
            <span class=p>}</span>
            <span class=n>RouteAnnotation</span><span class=o>*</span> <span class=n>item</span> <span class=o>=</span> <span class=p>[[</span><span class=n>RouteAnnotation</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>];</span>
            <span class=n>item</span><span class=p>.</span><span class=n>coordinate</span> <span class=o>=</span> <span class=n>transitStep</span><span class=p>.</span><span class=n>entrace</span><span class=p>.</span><span class=n>location</span><span class=p>;</span>
            <span class=n>item</span><span class=p>.</span><span class=n>title</span> <span class=o>=</span> <span class=n>transitStep</span><span class=p>.</span><span class=n>instruction</span><span class=p>;</span>
            <span class=n>item</span><span class=p>.</span><span class=n>type</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
            <span class=p>[</span><span class=n>_mapView</span> <span class=nl>addAnnotation</span><span class=p>:</span><span class=n>item</span><span class=p>];</span>
            <span class=p>[</span><span class=n>item</span> <span class=k>release</span><span class=p>];</span>
            
            <span class=c1>//轨迹点总数累计
</span><span class=c1></span>            <span class=n>planPointCounts</span> <span class=o>+=</span> <span class=n>transitStep</span><span class=p>.</span><span class=n>pointsCount</span><span class=p>;</span>
        <span class=p>}</span>
        
        <span class=c1>//轨迹点
</span><span class=c1></span>        <span class=n>BMKMapPoint</span> <span class=o>*</span> <span class=n>temppoints</span> <span class=o>=</span> <span class=n>new</span> <span class=n>BMKMapPoint</span><span class=p>[</span><span class=n>planPointCounts</span><span class=p>];</span>
        <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>BMKTransitStep</span><span class=o>*</span> <span class=n>transitStep</span> <span class=o>=</span> <span class=p>[</span><span class=n>plan</span><span class=p>.</span><span class=n>steps</span> <span class=nl>objectAtIndex</span><span class=p>:</span><span class=n>j</span><span class=p>];</span>
            <span class=kt>int</span> <span class=n>k</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
            <span class=k>for</span><span class=p>(</span><span class=n>k</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=n>k</span><span class=o>&lt;</span><span class=n>transitStep</span><span class=p>.</span><span class=n>pointsCount</span><span class=p>;</span><span class=n>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>temppoints</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>x</span> <span class=o>=</span> <span class=n>transitStep</span><span class=p>.</span><span class=n>points</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>x</span><span class=p>;</span>
                <span class=n>temppoints</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>y</span> <span class=o>=</span> <span class=n>transitStep</span><span class=p>.</span><span class=n>points</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>y</span><span class=p>;</span>
                <span class=n>i</span><span class=o>++</span><span class=p>;</span>
            <span class=p>}</span>            
        <span class=p>}</span>
        <span class=c1>// 通过points构建BMKPolyline
</span><span class=c1></span>        <span class=n>BMKPolyline</span><span class=o>*</span> <span class=n>polyLine</span> <span class=o>=</span> <span class=p>[</span><span class=n>BMKPolyline</span> <span class=nl>polylineWithPoints</span><span class=p>:</span><span class=n>temppoints</span> <span class=nl>count</span><span class=p>:</span><span class=n>planPointCounts</span><span class=p>];</span>
        <span class=p>[</span><span class=n>_mapView</span> <span class=nl>addOverlay</span><span class=p>:</span><span class=n>polyLine</span><span class=p>];</span> <span class=c1>// 添加路线overlay
</span><span class=c1></span>        <span class=n>delete</span> <span class=p>[]</span><span class=n>temppoints</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=c1>//驾车的路线绘制
</span><span class=c1></span><span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>onGetDrivingRouteResult:</span><span class=p>(</span><span class=n>BMKRouteSearch</span><span class=o>*</span><span class=p>)</span><span class=nv>searcher</span> <span class=nf>result:</span><span class=p>(</span><span class=n>BMKDrivingRouteResult</span><span class=o>*</span><span class=p>)</span><span class=nv>result</span> <span class=nf>errorCode:</span><span class=p>(</span><span class=n>BMKSearchErrorCode</span><span class=p>)</span><span class=nv>error</span> <span class=p>{</span>

    <span class=n>MapExplainViewController</span> <span class=o>*</span><span class=n>exp</span><span class=o>=</span><span class=p>[[[</span><span class=n>MapExplainViewController</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>]</span><span class=n>autorelease</span><span class=p>];</span>
    <span class=n>exp</span><span class=p>.</span><span class=n>array</span><span class=o>=</span><span class=n>result</span><span class=p>.</span><span class=n>routes</span><span class=p>;</span>
    <span class=p>[</span><span class=nb>self</span><span class=p>.</span><span class=n>navigationController</span> <span class=nl>pushViewController</span><span class=p>:</span><span class=n>exp</span> <span class=nl>animated</span><span class=p>:</span><span class=nb>YES</span><span class=p>];</span>
    <span class=n>NSArray</span><span class=o>*</span> <span class=n>array</span> <span class=o>=</span> <span class=p>[</span><span class=n>NSArray</span> <span class=nl>arrayWithArray</span><span class=p>:</span><span class=n>_mapView</span><span class=p>.</span><span class=n>annotations</span><span class=p>];</span>
    <span class=p>[</span><span class=n>_mapView</span> <span class=nl>removeAnnotations</span><span class=p>:</span><span class=n>array</span><span class=p>];</span>
    <span class=n>array</span> <span class=o>=</span> <span class=p>[</span><span class=n>NSArray</span> <span class=nl>arrayWithArray</span><span class=p>:</span><span class=n>_mapView</span><span class=p>.</span><span class=n>overlays</span><span class=p>];</span>
    <span class=p>[</span><span class=n>_mapView</span> <span class=nl>removeOverlays</span><span class=p>:</span><span class=n>array</span><span class=p>];</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>error</span> <span class=o>==</span> <span class=n>BMK_SEARCH_NO_ERROR</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>BMKDrivingRouteLine</span><span class=o>*</span> <span class=n>plan</span> <span class=o>=</span> <span class=p>(</span><span class=n>BMKDrivingRouteLine</span><span class=o>*</span><span class=p>)[</span><span class=n>result</span><span class=p>.</span><span class=n>routes</span> <span class=nl>objectAtIndex</span><span class=p>:</span><span class=mi>0</span><span class=p>];</span>
        <span class=c1>// 计算路线方案中的路段数目
</span><span class=c1></span>        <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=p>[</span><span class=n>plan</span><span class=p>.</span><span class=n>steps</span> <span class=n>count</span><span class=p>];</span>
        <span class=kt>int</span> <span class=n>planPointCounts</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>BMKDrivingStep</span><span class=o>*</span> <span class=n>transitStep</span> <span class=o>=</span> <span class=p>[</span><span class=n>plan</span><span class=p>.</span><span class=n>steps</span> <span class=nl>objectAtIndex</span><span class=p>:</span><span class=n>i</span><span class=p>];</span>
            <span class=k>if</span><span class=p>(</span><span class=n>i</span><span class=o>==</span><span class=mi>0</span><span class=p>){</span>
                <span class=n>RouteAnnotation</span><span class=o>*</span> <span class=n>item</span> <span class=o>=</span> <span class=p>[[</span><span class=n>RouteAnnotation</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>];</span>
                <span class=n>item</span><span class=p>.</span><span class=n>coordinate</span> <span class=o>=</span> <span class=n>plan</span><span class=p>.</span><span class=n>starting</span><span class=p>.</span><span class=n>location</span><span class=p>;</span>
                <span class=n>item</span><span class=p>.</span><span class=n>title</span> <span class=o>=</span> <span class=s>@&#34;起点&#34;</span><span class=p>;</span>
                <span class=n>item</span><span class=p>.</span><span class=n>type</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
                <span class=p>[</span><span class=n>_mapView</span> <span class=nl>addAnnotation</span><span class=p>:</span><span class=n>item</span><span class=p>];</span> <span class=c1>// 添加起点标注
</span><span class=c1></span>                <span class=p>[</span><span class=n>item</span> <span class=k>release</span><span class=p>];</span>
            <span class=p>}</span>
            <span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=n>i</span><span class=o>==</span><span class=n>size</span><span class=o>-</span><span class=mi>1</span><span class=p>){</span>
                <span class=n>RouteAnnotation</span><span class=o>*</span> <span class=n>item</span> <span class=o>=</span> <span class=p>[[</span><span class=n>RouteAnnotation</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>];</span>
                <span class=n>item</span><span class=p>.</span><span class=n>coordinate</span> <span class=o>=</span> <span class=n>plan</span><span class=p>.</span><span class=n>terminal</span><span class=p>.</span><span class=n>location</span><span class=p>;</span>
                <span class=n>item</span><span class=p>.</span><span class=n>title</span> <span class=o>=</span> <span class=s>@&#34;终点&#34;</span><span class=p>;</span>
                <span class=n>item</span><span class=p>.</span><span class=n>type</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
                <span class=p>[</span><span class=n>_mapView</span> <span class=nl>addAnnotation</span><span class=p>:</span><span class=n>item</span><span class=p>];</span> <span class=c1>// 添加起点标注
</span><span class=c1></span>                <span class=p>[</span><span class=n>item</span> <span class=k>release</span><span class=p>];</span>
            <span class=p>}</span>
            <span class=c1>//添加annotation节点
</span><span class=c1></span>            <span class=n>RouteAnnotation</span><span class=o>*</span> <span class=n>item</span> <span class=o>=</span> <span class=p>[[</span><span class=n>RouteAnnotation</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>];</span>
            <span class=n>item</span><span class=p>.</span><span class=n>coordinate</span> <span class=o>=</span> <span class=n>transitStep</span><span class=p>.</span><span class=n>entrace</span><span class=p>.</span><span class=n>location</span><span class=p>;</span>
            <span class=n>item</span><span class=p>.</span><span class=n>title</span> <span class=o>=</span> <span class=n>transitStep</span><span class=p>.</span><span class=n>entraceInstruction</span><span class=p>;</span>
            <span class=n>item</span><span class=p>.</span><span class=n>degree</span> <span class=o>=</span> <span class=n>transitStep</span><span class=p>.</span><span class=n>direction</span> <span class=o>*</span> <span class=mi>30</span><span class=p>;</span>
            <span class=n>item</span><span class=p>.</span><span class=n>type</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
            <span class=p>[</span><span class=n>_mapView</span> <span class=nl>addAnnotation</span><span class=p>:</span><span class=n>item</span><span class=p>];</span>
            <span class=p>[</span><span class=n>item</span> <span class=k>release</span><span class=p>];</span>
            <span class=c1>//轨迹点总数累计
</span><span class=c1></span>            <span class=n>planPointCounts</span> <span class=o>+=</span> <span class=n>transitStep</span><span class=p>.</span><span class=n>pointsCount</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=c1>// 添加途经点
</span><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>plan</span><span class=p>.</span><span class=n>wayPoints</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>for</span> <span class=p>(</span><span class=n>BMKPlanNode</span><span class=o>*</span> <span class=n>tempNode</span> <span class=k>in</span> <span class=n>plan</span><span class=p>.</span><span class=n>wayPoints</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>RouteAnnotation</span><span class=o>*</span> <span class=n>item</span> <span class=o>=</span> <span class=p>[[</span><span class=n>RouteAnnotation</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>];</span>
                <span class=n>item</span> <span class=o>=</span> <span class=p>[[</span><span class=n>RouteAnnotation</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>];</span>
                <span class=n>item</span><span class=p>.</span><span class=n>coordinate</span> <span class=o>=</span> <span class=n>tempNode</span><span class=p>.</span><span class=n>pt</span><span class=p>;</span>
                <span class=n>item</span><span class=p>.</span><span class=n>type</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span>
                <span class=n>item</span><span class=p>.</span><span class=n>title</span> <span class=o>=</span> <span class=n>tempNode</span><span class=p>.</span><span class=n>name</span><span class=p>;</span>
                <span class=p>[</span><span class=n>_mapView</span> <span class=nl>addAnnotation</span><span class=p>:</span><span class=n>item</span><span class=p>];</span>
                <span class=p>[</span><span class=n>item</span> <span class=k>release</span><span class=p>];</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=c1>//轨迹点
</span><span class=c1></span>        <span class=n>BMKMapPoint</span> <span class=o>*</span> <span class=n>temppoints</span> <span class=o>=</span> <span class=n>new</span> <span class=n>BMKMapPoint</span><span class=p>[</span><span class=n>planPointCounts</span><span class=p>];</span>
        <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>BMKDrivingStep</span><span class=o>*</span> <span class=n>transitStep</span> <span class=o>=</span> <span class=p>[</span><span class=n>plan</span><span class=p>.</span><span class=n>steps</span> <span class=nl>objectAtIndex</span><span class=p>:</span><span class=n>j</span><span class=p>];</span>
            <span class=kt>int</span> <span class=n>k</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
            <span class=k>for</span><span class=p>(</span><span class=n>k</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=n>k</span><span class=o>&lt;</span><span class=n>transitStep</span><span class=p>.</span><span class=n>pointsCount</span><span class=p>;</span><span class=n>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>temppoints</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>x</span> <span class=o>=</span> <span class=n>transitStep</span><span class=p>.</span><span class=n>points</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>x</span><span class=p>;</span>
                <span class=n>temppoints</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>y</span> <span class=o>=</span> <span class=n>transitStep</span><span class=p>.</span><span class=n>points</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>y</span><span class=p>;</span>
                <span class=n>i</span><span class=o>++</span><span class=p>;</span>
            <span class=p>}</span>            
        <span class=p>}</span>
        <span class=c1>// 通过points构建BMKPolyline
</span><span class=c1></span>        <span class=n>BMKPolyline</span><span class=o>*</span> <span class=n>polyLine</span> <span class=o>=</span> <span class=p>[</span><span class=n>BMKPolyline</span> <span class=nl>polylineWithPoints</span><span class=p>:</span><span class=n>temppoints</span> <span class=nl>count</span><span class=p>:</span><span class=n>planPointCounts</span><span class=p>];</span>
        <span class=p>[</span><span class=n>_mapView</span> <span class=nl>addOverlay</span><span class=p>:</span><span class=n>polyLine</span><span class=p>];</span> <span class=c1>// 添加路线overlay
</span><span class=c1></span>        <span class=n>delete</span> <span class=p>[]</span><span class=n>temppoints</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=c1>//步行的路线绘制
</span><span class=c1></span><span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>onGetWalkingRouteResult:</span><span class=p>(</span><span class=n>BMKRouteSearch</span><span class=o>*</span><span class=p>)</span><span class=nv>searcher</span> <span class=nf>result:</span><span class=p>(</span><span class=n>BMKWalkingRouteResult</span><span class=o>*</span><span class=p>)</span><span class=nv>result</span> <span class=nf>errorCode:</span><span class=p>(</span><span class=n>BMKSearchErrorCode</span><span class=p>)</span><span class=nv>error</span> <span class=p>{</span>
    <span class=n>MapExplainViewController</span> <span class=o>*</span><span class=n>exp</span><span class=o>=</span><span class=p>[[[</span><span class=n>MapExplainViewController</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>]</span>
                                   <span class=n>autorelease</span><span class=p>];</span>
    <span class=n>exp</span><span class=p>.</span><span class=n>array</span><span class=o>=</span><span class=n>result</span><span class=p>.</span><span class=n>routes</span><span class=p>;</span>
    <span class=p>[</span><span class=nb>self</span><span class=p>.</span><span class=n>navigationController</span> <span class=nl>pushViewController</span><span class=p>:</span><span class=n>exp</span> <span class=nl>animated</span><span class=p>:</span><span class=nb>YES</span><span class=p>];</span>
    <span class=n>NSArray</span><span class=o>*</span> <span class=n>array</span> <span class=o>=</span> <span class=p>[</span><span class=n>NSArray</span> <span class=nl>arrayWithArray</span><span class=p>:</span><span class=n>_mapView</span><span class=p>.</span><span class=n>annotations</span><span class=p>];</span>
    <span class=p>[</span><span class=n>_mapView</span> <span class=nl>removeAnnotations</span><span class=p>:</span><span class=n>array</span><span class=p>];</span>
    <span class=n>array</span> <span class=o>=</span> <span class=p>[</span><span class=n>NSArray</span> <span class=nl>arrayWithArray</span><span class=p>:</span><span class=n>_mapView</span><span class=p>.</span><span class=n>overlays</span><span class=p>];</span>
    <span class=p>[</span><span class=n>_mapView</span> <span class=nl>removeOverlays</span><span class=p>:</span><span class=n>array</span><span class=p>];</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>error</span> <span class=o>==</span> <span class=n>BMK_SEARCH_NO_ERROR</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>BMKWalkingRouteLine</span><span class=o>*</span> <span class=n>plan</span> <span class=o>=</span> <span class=p>(</span><span class=n>BMKWalkingRouteLine</span><span class=o>*</span><span class=p>)[</span><span class=n>result</span><span class=p>.</span><span class=n>routes</span> <span class=nl>objectAtIndex</span><span class=p>:</span><span class=mi>0</span><span class=p>];</span>
        <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=p>[</span><span class=n>plan</span><span class=p>.</span><span class=n>steps</span> <span class=n>count</span><span class=p>];</span>
        <span class=kt>int</span> <span class=n>planPointCounts</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>BMKWalkingStep</span><span class=o>*</span> <span class=n>transitStep</span> <span class=o>=</span> <span class=p>[</span><span class=n>plan</span><span class=p>.</span><span class=n>steps</span> <span class=nl>objectAtIndex</span><span class=p>:</span><span class=n>i</span><span class=p>];</span>
            <span class=k>if</span><span class=p>(</span><span class=n>i</span><span class=o>==</span><span class=mi>0</span><span class=p>){</span>
                <span class=n>RouteAnnotation</span><span class=o>*</span> <span class=n>item</span> <span class=o>=</span> <span class=p>[[</span><span class=n>RouteAnnotation</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>];</span>
                <span class=n>item</span><span class=p>.</span><span class=n>coordinate</span> <span class=o>=</span> <span class=n>plan</span><span class=p>.</span><span class=n>starting</span><span class=p>.</span><span class=n>location</span><span class=p>;</span>
                <span class=n>item</span><span class=p>.</span><span class=n>title</span> <span class=o>=</span> <span class=s>@&#34;起点&#34;</span><span class=p>;</span>
                <span class=n>item</span><span class=p>.</span><span class=n>type</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
                <span class=p>[</span><span class=n>_mapView</span> <span class=nl>addAnnotation</span><span class=p>:</span><span class=n>item</span><span class=p>];</span> <span class=c1>// 添加起点标注
</span><span class=c1></span>                <span class=p>[</span><span class=n>item</span> <span class=k>release</span><span class=p>];</span>
                
            <span class=p>}</span>
            <span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=n>i</span><span class=o>==</span><span class=n>size</span><span class=o>-</span><span class=mi>1</span><span class=p>){</span>
                <span class=n>RouteAnnotation</span><span class=o>*</span> <span class=n>item</span> <span class=o>=</span> <span class=p>[[</span><span class=n>RouteAnnotation</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>];</span>
                <span class=n>item</span><span class=p>.</span><span class=n>coordinate</span> <span class=o>=</span> <span class=n>plan</span><span class=p>.</span><span class=n>terminal</span><span class=p>.</span><span class=n>location</span><span class=p>;</span>
                <span class=n>item</span><span class=p>.</span><span class=n>title</span> <span class=o>=</span> <span class=s>@&#34;终点&#34;</span><span class=p>;</span>
                <span class=n>item</span><span class=p>.</span><span class=n>type</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
                <span class=p>[</span><span class=n>_mapView</span> <span class=nl>addAnnotation</span><span class=p>:</span><span class=n>item</span><span class=p>];</span> <span class=c1>// 添加起点标注
</span><span class=c1></span>                <span class=p>[</span><span class=n>item</span> <span class=k>release</span><span class=p>];</span>
            <span class=p>}</span>
            <span class=c1>//添加annotation节点
</span><span class=c1></span>            <span class=n>RouteAnnotation</span><span class=o>*</span> <span class=n>item</span> <span class=o>=</span> <span class=p>[[</span><span class=n>RouteAnnotation</span> <span class=n>alloc</span><span class=p>]</span><span class=n>init</span><span class=p>];</span>
            <span class=n>item</span><span class=p>.</span><span class=n>coordinate</span> <span class=o>=</span> <span class=n>transitStep</span><span class=p>.</span><span class=n>entrace</span><span class=p>.</span><span class=n>location</span><span class=p>;</span>
            <span class=n>item</span><span class=p>.</span><span class=n>title</span> <span class=o>=</span> <span class=n>transitStep</span><span class=p>.</span><span class=n>entraceInstruction</span><span class=p>;</span>
            <span class=n>item</span><span class=p>.</span><span class=n>degree</span> <span class=o>=</span> <span class=n>transitStep</span><span class=p>.</span><span class=n>direction</span> <span class=o>*</span> <span class=mi>30</span><span class=p>;</span>
            <span class=n>item</span><span class=p>.</span><span class=n>type</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
            <span class=p>[</span><span class=n>_mapView</span> <span class=nl>addAnnotation</span><span class=p>:</span><span class=n>item</span><span class=p>];</span>
            <span class=p>[</span><span class=n>item</span> <span class=k>release</span><span class=p>];</span>
            <span class=c1>//轨迹点总数累计
</span><span class=c1></span>            <span class=n>planPointCounts</span> <span class=o>+=</span> <span class=n>transitStep</span><span class=p>.</span><span class=n>pointsCount</span><span class=p>;</span>
        <span class=p>}</span>
        
        <span class=c1>//轨迹点
</span><span class=c1></span>        <span class=n>BMKMapPoint</span> <span class=o>*</span> <span class=n>temppoints</span> <span class=o>=</span> <span class=n>new</span> <span class=n>BMKMapPoint</span><span class=p>[</span><span class=n>planPointCounts</span><span class=p>];</span>
        <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>BMKWalkingStep</span><span class=o>*</span> <span class=n>transitStep</span> <span class=o>=</span> <span class=p>[</span><span class=n>plan</span><span class=p>.</span><span class=n>steps</span> <span class=nl>objectAtIndex</span><span class=p>:</span><span class=n>j</span><span class=p>];</span>
            <span class=kt>int</span> <span class=n>k</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
            <span class=k>for</span><span class=p>(</span><span class=n>k</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=n>k</span><span class=o>&lt;</span><span class=n>transitStep</span><span class=p>.</span><span class=n>pointsCount</span><span class=p>;</span><span class=n>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>temppoints</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>x</span> <span class=o>=</span> <span class=n>transitStep</span><span class=p>.</span><span class=n>points</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>x</span><span class=p>;</span>
                <span class=n>temppoints</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>y</span> <span class=o>=</span> <span class=n>transitStep</span><span class=p>.</span><span class=n>points</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>y</span><span class=p>;</span>
                <span class=n>i</span><span class=o>++</span><span class=p>;</span>
            <span class=p>}</span>
            
        <span class=p>}</span>
        <span class=c1>// 通过points构建BMKPolyline
</span><span class=c1></span>        <span class=n>BMKPolyline</span><span class=o>*</span> <span class=n>polyLine</span> <span class=o>=</span> <span class=p>[</span><span class=n>BMKPolyline</span> <span class=nl>polylineWithPoints</span><span class=p>:</span><span class=n>temppoints</span> <span class=nl>count</span><span class=p>:</span><span class=n>planPointCounts</span><span class=p>];</span>
        <span class=p>[</span><span class=n>_mapView</span> <span class=nl>addOverlay</span><span class=p>:</span><span class=n>polyLine</span><span class=p>];</span> <span class=c1>// 添加路线overlay
</span><span class=c1></span>        <span class=n>delete</span> <span class=p>[]</span><span class=n>temppoints</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>搜索的回调代理成功后，需要在mapview 上绘制线条：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=c1>///&lt;0:起点 1：终点 2：公交 3：地铁 4:驾乘 5:途经点
</span><span class=c1></span><span class=p>-</span> <span class=p>(</span><span class=n>BMKAnnotationView</span><span class=o>*</span><span class=p>)</span><span class=nf>getRouteAnnotationView:</span><span class=p>(</span><span class=n>BMKMapView</span> <span class=o>*</span><span class=p>)</span><span class=nv>mapview</span> <span class=nf>viewForAnnotation:</span><span class=p>(</span><span class=n>RouteAnnotation</span><span class=o>*</span><span class=p>)</span><span class=nv>routeAnnotation</span> <span class=p>{</span>
    <span class=n>BMKAnnotationView</span><span class=o>*</span> <span class=n>view</span> <span class=o>=</span> <span class=nb>nil</span><span class=p>;</span>
    <span class=k>switch</span> <span class=p>(</span><span class=n>routeAnnotation</span><span class=p>.</span><span class=n>type</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>case</span> <span class=mi>0</span><span class=o>:</span>
        <span class=p>{</span>
            <span class=n>view</span> <span class=o>=</span> <span class=p>[</span><span class=n>mapview</span> <span class=nl>dequeueReusableAnnotationViewWithIdentifier</span><span class=p>:</span><span class=s>@&#34;start_node&#34;</span><span class=p>];</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>view</span> <span class=o>==</span> <span class=nb>nil</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>view</span> <span class=o>=</span> <span class=p>[[[</span><span class=n>BMKAnnotationView</span> <span class=n>alloc</span><span class=p>]</span><span class=nl>initWithAnnotation</span><span class=p>:</span><span class=n>routeAnnotation</span> <span class=nl>reuseIdentifier</span><span class=p>:</span><span class=s>@&#34;start_node&#34;</span><span class=p>]</span> <span class=n>autorelease</span><span class=p>];</span>
                <span class=n>view</span><span class=p>.</span><span class=n>image</span> <span class=o>=</span> <span class=p>[</span><span class=n>UIImage</span> <span class=nl>imageWithContentsOfFile</span><span class=p>:[</span><span class=nb>self</span> <span class=nl>getMyBundlePath1</span><span class=p>:</span><span class=s>@&#34;images/icon_nav_start.png&#34;</span><span class=p>]];</span>
                <span class=n>view</span><span class=p>.</span><span class=n>centerOffset</span> <span class=o>=</span> <span class=n>CGPointMake</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=n>frame</span><span class=p>.</span><span class=n>size</span><span class=p>.</span><span class=n>height</span> <span class=o>*</span> <span class=mf>0.5</span><span class=p>));</span>
                <span class=n>view</span><span class=p>.</span><span class=n>canShowCallout</span> <span class=o>=</span> <span class=nb>TRUE</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=n>view</span><span class=p>.</span><span class=n>annotation</span> <span class=o>=</span> <span class=n>routeAnnotation</span><span class=p>;</span>
        <span class=p>}</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=k>case</span> <span class=mi>1</span><span class=o>:</span>
        <span class=p>{</span>
            <span class=n>view</span> <span class=o>=</span> <span class=p>[</span><span class=n>mapview</span> <span class=nl>dequeueReusableAnnotationViewWithIdentifier</span><span class=p>:</span><span class=s>@&#34;end_node&#34;</span><span class=p>];</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>view</span> <span class=o>==</span> <span class=nb>nil</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>view</span> <span class=o>=</span> <span class=p>[[[</span><span class=n>BMKAnnotationView</span> <span class=n>alloc</span><span class=p>]</span><span class=nl>initWithAnnotation</span><span class=p>:</span><span class=n>routeAnnotation</span> <span class=nl>reuseIdentifier</span><span class=p>:</span><span class=s>@&#34;end_node&#34;</span><span class=p>]</span> <span class=n>autorelease</span><span class=p>];</span>
                <span class=n>view</span><span class=p>.</span><span class=n>image</span> <span class=o>=</span> <span class=p>[</span><span class=n>UIImage</span> <span class=nl>imageWithContentsOfFile</span><span class=p>:[</span><span class=nb>self</span> <span class=nl>getMyBundlePath1</span><span class=p>:</span><span class=s>@&#34;images/icon_nav_end.png&#34;</span><span class=p>]];</span>
                <span class=n>view</span><span class=p>.</span><span class=n>centerOffset</span> <span class=o>=</span> <span class=n>CGPointMake</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=n>frame</span><span class=p>.</span><span class=n>size</span><span class=p>.</span><span class=n>height</span> <span class=o>*</span> <span class=mf>0.5</span><span class=p>));</span>
                <span class=n>view</span><span class=p>.</span><span class=n>canShowCallout</span> <span class=o>=</span> <span class=nb>TRUE</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=n>view</span><span class=p>.</span><span class=n>annotation</span> <span class=o>=</span> <span class=n>routeAnnotation</span><span class=p>;</span>
        <span class=p>}</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=k>case</span> <span class=mi>2</span><span class=o>:</span>
        <span class=p>{</span>
            <span class=n>view</span> <span class=o>=</span> <span class=p>[</span><span class=n>mapview</span> <span class=nl>dequeueReusableAnnotationViewWithIdentifier</span><span class=p>:</span><span class=s>@&#34;bus_node&#34;</span><span class=p>];</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>view</span> <span class=o>==</span> <span class=nb>nil</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>view</span> <span class=o>=</span> <span class=p>[[[</span><span class=n>BMKAnnotationView</span> <span class=n>alloc</span><span class=p>]</span><span class=nl>initWithAnnotation</span><span class=p>:</span><span class=n>routeAnnotation</span> <span class=nl>reuseIdentifier</span><span class=p>:</span><span class=s>@&#34;bus_node&#34;</span><span class=p>]</span> <span class=n>autorelease</span><span class=p>];</span>
                <span class=n>view</span><span class=p>.</span><span class=n>image</span> <span class=o>=</span> <span class=p>[</span><span class=n>UIImage</span> <span class=nl>imageWithContentsOfFile</span><span class=p>:[</span><span class=nb>self</span> <span class=nl>getMyBundlePath1</span><span class=p>:</span><span class=s>@&#34;images/icon_nav_bus.png&#34;</span><span class=p>]];</span>
                <span class=n>view</span><span class=p>.</span><span class=n>canShowCallout</span> <span class=o>=</span> <span class=nb>TRUE</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=n>view</span><span class=p>.</span><span class=n>annotation</span> <span class=o>=</span> <span class=n>routeAnnotation</span><span class=p>;</span>
        <span class=p>}</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=k>case</span> <span class=mi>3</span><span class=o>:</span>
        <span class=p>{</span>
            <span class=n>view</span> <span class=o>=</span> <span class=p>[</span><span class=n>mapview</span> <span class=nl>dequeueReusableAnnotationViewWithIdentifier</span><span class=p>:</span><span class=s>@&#34;rail_node&#34;</span><span class=p>];</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>view</span> <span class=o>==</span> <span class=nb>nil</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>view</span> <span class=o>=</span> <span class=p>[[[</span><span class=n>BMKAnnotationView</span> <span class=n>alloc</span><span class=p>]</span><span class=nl>initWithAnnotation</span><span class=p>:</span><span class=n>routeAnnotation</span> <span class=nl>reuseIdentifier</span><span class=p>:</span><span class=s>@&#34;rail_node&#34;</span><span class=p>]</span> <span class=n>autorelease</span><span class=p>];</span>
                <span class=n>view</span><span class=p>.</span><span class=n>image</span> <span class=o>=</span> <span class=p>[</span><span class=n>UIImage</span> <span class=nl>imageWithContentsOfFile</span><span class=p>:[</span><span class=nb>self</span> <span class=nl>getMyBundlePath1</span><span class=p>:</span><span class=s>@&#34;images/icon_nav_rail.png&#34;</span><span class=p>]];</span>
                <span class=n>view</span><span class=p>.</span><span class=n>canShowCallout</span> <span class=o>=</span> <span class=nb>TRUE</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=n>view</span><span class=p>.</span><span class=n>annotation</span> <span class=o>=</span> <span class=n>routeAnnotation</span><span class=p>;</span>
        <span class=p>}</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=k>case</span> <span class=mi>4</span><span class=o>:</span>
        <span class=p>{</span>
            <span class=n>view</span> <span class=o>=</span> <span class=p>[</span><span class=n>mapview</span> <span class=nl>dequeueReusableAnnotationViewWithIdentifier</span><span class=p>:</span><span class=s>@&#34;route_node&#34;</span><span class=p>];</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>view</span> <span class=o>==</span> <span class=nb>nil</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>view</span> <span class=o>=</span> <span class=p>[[[</span><span class=n>BMKAnnotationView</span> <span class=n>alloc</span><span class=p>]</span><span class=nl>initWithAnnotation</span><span class=p>:</span><span class=n>routeAnnotation</span> <span class=nl>reuseIdentifier</span><span class=p>:</span><span class=s>@&#34;route_node&#34;</span><span class=p>]</span> <span class=n>autorelease</span><span class=p>];</span>
                <span class=n>view</span><span class=p>.</span><span class=n>canShowCallout</span> <span class=o>=</span> <span class=nb>TRUE</span><span class=p>;</span>
            <span class=p>}</span> 
            <span class=k>else</span> <span class=p>{</span>
                <span class=p>[</span><span class=n>view</span> <span class=n>setNeedsDisplay</span><span class=p>];</span>
            <span class=p>}</span>
            
            <span class=n>UIImage</span><span class=o>*</span> <span class=n>image</span> <span class=o>=</span> <span class=p>[</span><span class=n>UIImage</span> <span class=nl>imageWithContentsOfFile</span><span class=p>:[</span><span class=nb>self</span> <span class=nl>getMyBundlePath1</span><span class=p>:</span><span class=s>@&#34;images/icon_direction.png&#34;</span><span class=p>]];</span>
            <span class=n>view</span><span class=p>.</span><span class=n>image</span> <span class=o>=</span> <span class=p>[</span><span class=n>image</span> <span class=nl>imageRotatedByDegrees</span><span class=p>:</span><span class=n>routeAnnotation</span><span class=p>.</span><span class=n>degree</span><span class=p>];</span>
            <span class=n>view</span><span class=p>.</span><span class=n>annotation</span> <span class=o>=</span> <span class=n>routeAnnotation</span><span class=p>;</span>
            
        <span class=p>}</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=k>case</span> <span class=mi>5</span><span class=o>:</span>
        <span class=p>{</span>
            <span class=n>view</span> <span class=o>=</span> <span class=p>[</span><span class=n>mapview</span> <span class=nl>dequeueReusableAnnotationViewWithIdentifier</span><span class=p>:</span><span class=s>@&#34;waypoint_node&#34;</span><span class=p>];</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>view</span> <span class=o>==</span> <span class=nb>nil</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>view</span> <span class=o>=</span> <span class=p>[[[</span><span class=n>BMKAnnotationView</span> <span class=n>alloc</span><span class=p>]</span><span class=nl>initWithAnnotation</span><span class=p>:</span><span class=n>routeAnnotation</span> <span class=nl>reuseIdentifier</span><span class=p>:</span><span class=s>@&#34;waypoint_node&#34;</span><span class=p>]</span> <span class=n>autorelease</span><span class=p>];</span>
                <span class=n>view</span><span class=p>.</span><span class=n>canShowCallout</span> <span class=o>=</span> <span class=nb>TRUE</span><span class=p>;</span>
            <span class=p>}</span> 
            <span class=k>else</span> <span class=p>{</span>
                <span class=p>[</span><span class=n>view</span> <span class=n>setNeedsDisplay</span><span class=p>];</span>
            <span class=p>}</span>
            
            <span class=n>UIImage</span><span class=o>*</span> <span class=n>image</span> <span class=o>=</span> <span class=p>[</span><span class=n>UIImage</span> <span class=nl>imageWithContentsOfFile</span><span class=p>:[</span><span class=nb>self</span> <span class=nl>getMyBundlePath1</span><span class=p>:</span><span class=s>@&#34;images/icon_nav_waypoint.png&#34;</span><span class=p>]];</span>
            <span class=n>view</span><span class=p>.</span><span class=n>image</span> <span class=o>=</span> <span class=p>[</span><span class=n>image</span> <span class=nl>imageRotatedByDegrees</span><span class=p>:</span><span class=n>routeAnnotation</span><span class=p>.</span><span class=n>degree</span><span class=p>];</span>
            <span class=n>view</span><span class=p>.</span><span class=n>annotation</span> <span class=o>=</span> <span class=n>routeAnnotation</span><span class=p>;</span>
        <span class=p>}</span>
            <span class=k>break</span><span class=p>;</span>
        <span class=k>default</span><span class=o>:</span>
            <span class=k>break</span><span class=p>;</span>
    <span class=p>}</span>
    
    <span class=k>return</span> <span class=n>view</span><span class=p>;</span>
<span class=p>}</span>

<span class=p>-</span> <span class=p>(</span><span class=n>BMKAnnotationView</span> <span class=o>*</span><span class=p>)</span><span class=nf>mapView:</span><span class=p>(</span><span class=n>BMKMapView</span> <span class=o>*</span><span class=p>)</span><span class=nv>view</span> <span class=nf>viewForAnnotation:</span><span class=p>(</span><span class=kt>id</span> <span class=o>&lt;</span><span class=n>BMKAnnotation</span><span class=o>&gt;</span><span class=p>)</span><span class=nv>annotation</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>([</span><span class=n>annotation</span> <span class=nl>isKindOfClass</span><span class=p>:[</span><span class=n>RouteAnnotation</span> <span class=k>class</span><span class=p>]])</span> <span class=p>{</span>
        <span class=k>return</span> <span class=p>[</span><span class=nb>self</span> <span class=nl>getRouteAnnotationView</span><span class=p>:</span><span class=n>view</span> <span class=nl>viewForAnnotation</span><span class=p>:(</span><span class=n>RouteAnnotation</span><span class=o>*</span><span class=p>)</span><span class=n>annotation</span><span class=p>];</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=nb>nil</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>//加载线路
</span><span class=c1></span><span class=p>-</span> <span class=p>(</span><span class=n>BMKOverlayView</span><span class=o>*</span><span class=p>)</span><span class=nf>mapView:</span><span class=p>(</span><span class=n>BMKMapView</span> <span class=o>*</span><span class=p>)</span><span class=nv>map</span> <span class=nf>viewForOverlay:</span><span class=p>(</span><span class=kt>id</span><span class=o>&lt;</span><span class=n>BMKOverlay</span><span class=o>&gt;</span><span class=p>)</span><span class=nv>overlay</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>([</span><span class=n>overlay</span> <span class=nl>isKindOfClass</span><span class=p>:[</span><span class=n>BMKPolyline</span> <span class=k>class</span><span class=p>]])</span> <span class=p>{</span>
        <span class=n>BMKPolylineView</span><span class=o>*</span> <span class=n>polylineView</span> <span class=o>=</span> <span class=p>[[[</span><span class=n>BMKPolylineView</span> <span class=n>alloc</span><span class=p>]</span> <span class=nl>initWithOverlay</span><span class=p>:</span><span class=n>overlay</span><span class=p>]</span> <span class=n>autorelease</span><span class=p>];</span>
        <span class=n>polylineView</span><span class=p>.</span><span class=n>fillColor</span> <span class=o>=</span> <span class=p>[[</span><span class=n>UIColor</span> <span class=n>cyanColor</span><span class=p>]</span> <span class=nl>colorWithAlphaComponent</span><span class=p>:</span><span class=mi>1</span><span class=p>];</span>
        <span class=n>polylineView</span><span class=p>.</span><span class=n>strokeColor</span> <span class=o>=</span> <span class=p>[[</span><span class=n>UIColor</span> <span class=n>blueColor</span><span class=p>]</span> <span class=nl>colorWithAlphaComponent</span><span class=p>:</span><span class=mf>0.7</span><span class=p>];</span>
        <span class=n>polylineView</span><span class=p>.</span><span class=n>lineWidth</span> <span class=o>=</span> <span class=mf>3.0</span><span class=p>;</span>
        <span class=k>return</span> <span class=n>polylineView</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=nb>nil</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>经过以上方法，基本上在mapview上就可以看到线路导航图，如果不行，可以那些错误枚举去查看原因，毕竟百度是中国的，所以SDK里的注释都是中文，对于英文渣渣的我来说，简直太幸福了。</p>
<blockquote>
<p>还有一个地方使用了百度定位来获取天气信息，比系统的地理反编码快很多，很快就获取到了所在位置的城市。</p>
</blockquote>
<blockquote>
<p>同样的天气api使用的是百度天气，返回的数据里直接就有对应天气的图片的url，虽然图片很丑，但是总比没有的强，下面是百度天气的api地址：</p>
</blockquote>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=p>-(</span><span class=kt>void</span><span class=p>)</span><span class=nf>WeatherRequest</span> <span class=p>{</span>
     <span class=p>[</span><span class=nb>self</span> <span class=nl>ShowWaitView</span><span class=p>:</span><span class=s>@&#34;正在加载中。。。&#34;</span><span class=p>];</span>
    <span class=c1>//[GlobalData GetInstance].GB_CityString 是自己获取到城市
</span><span class=c1></span>    <span class=n>NSString</span> <span class=o>*</span><span class=n>str</span> <span class=o>=</span> <span class=p>[[</span><span class=n>GlobalData</span> <span class=n>GetInstance</span><span class=p>].</span><span class=n>GB_CityString</span> <span class=n>URLEncoding</span><span class=p>];</span>
    <span class=c1>//用定位的城市请求 ak是自己申请的百度密钥
</span><span class=c1></span>    <span class=n>NSString</span> <span class=o>*</span><span class=n>strurl</span><span class=o>=</span><span class=p>[</span><span class=n>NSString</span> <span class=nl>stringWithFormat</span><span class=p>:</span><span class=s>@&#34;http://api.map.baidu.com/telematics/v3/weather?location=%@&amp;output=json&amp;ak=C3d2845360d091a5e8f42f605b7472ea&#34;</span><span class=p>,</span><span class=n>str</span><span class=p>];</span>
    <span class=n>ASIFormDataRequest</span> <span class=o>*</span><span class=n>weatherRequest</span> <span class=o>=</span> <span class=p>[[</span><span class=n>ASIFormDataRequest</span> <span class=n>alloc</span><span class=p>]</span> <span class=nl>initWithURL</span><span class=p>:[</span><span class=n>NSURL</span> <span class=nl>URLWithString</span><span class=p>:</span><span class=n>strurl</span><span class=p>]];</span>
    
    <span class=n>weatherRequest</span><span class=p>.</span><span class=n>delegate</span> <span class=o>=</span> <span class=nb>self</span><span class=p>;</span>
    <span class=p>[</span><span class=n>weatherRequest</span> <span class=n>startAsynchronous</span><span class=p>];</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=/tags/ios/>iOS</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/2015-12-11-ios-setting/>
<i class="iconfont icon-left"></i>
<span class="prev-text nav-default">如何跳转到各个系统设置界面</span>
<span class="prev-text nav-mobile">上一篇</span>
</a>
<a class=next href=/post/2015-11-13-sqlcipher/>
<span class="next-text nav-default">使用SQLCipher加密数据库</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i>
</a>
</nav>
</footer>
</article>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=social-links>
<a href=dongjiawang2008@163.com class="iconfont icon-email" title=email></a>
<a href=https://github.com/dongjiawang class="iconfont icon-github" title=github></a>
<a href=https://space.bilibili.com/13834686 class="iconfont icon-bilibili" title=bilibili></a>
<a href=https://blog.dongjiawang.top/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a>
</div>
<div class=copyright>
<span class=power-by>
由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动
</span>
<span class=division>|</span>
<span class=theme-info>
主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a>
</span>
<span class=copyright-year>
&copy;
2015 -
2021<span class=heart><i class="iconfont icon-heart"></i></span><span>dongjiawang</span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class="iconfont icon-up"></i>
</div>
</div>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js></script>
<script type=text/javascript>window.MathJax={tex:{}}</script>
<script async src=https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-141040294-1','auto'),ga('set','anonymizeIp',!0),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<script id=baidu_analytics>var _hmt=_hmt||[];(function(){var a,b;if(window.location.hostname==='localhost')return;a=document.createElement("script"),a.async=!0,a.src="https://hm.baidu.com/hm.js?fa4bbb246def5e07ea71011a568aceaa",b=document.getElementsByTagName("script")[0],b.parentNode.insertBefore(a,b)})()</script>
</body>
</html>